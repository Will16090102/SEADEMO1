<script>
  // Variable para almacenar la √∫ltima cotizaci√≥n
  let ultimaCotizacion = null;

  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
  }

  function calcular() {
    const peso = parseFloat(document.getElementById("peso").value);
    const valor = parseFloat(document.getElementById("valor").value);
    const producto = document.getElementById("producto").value;

    if (isNaN(peso) || peso <= 0) {
      alert("Por favor ingresa un peso v√°lido (m√≠nimo 0.1 kg)");
      return;
    }
    if (isNaN(valor) || valor <= 0) {
      alert("Por favor ingresa un valor declarado v√°lido (m√≠nimo $1)");
      return;
    }

    const envio = peso <= 1 ? 12 : 12 * peso;
    const desaduanaje = 8;

    let impuestos = 0;
    if (valor > 200) {
      const adValorem = valor * 0.04;
      const igv = (valor + adValorem) * 0.18;
      impuestos = adValorem + igv;
    }

    const seguro = valor * 0.0035;
    const total = valor + envio + desaduanaje + impuestos + seguro;

    ultimaCotizacion = {
      tipo: "manual",
      producto: producto || "Sin descripci√≥n",
      peso,
      valor,
      desaduanaje,
      envioTotal: envio + desaduanaje,
      impuestos,
      seguro,
      total
    };

    actualizarEnlaceWhatsApp();
    mostrarResultados();
  }

  function mostrarResultados() {
    const resultSection = document.getElementById("result-section");
    resultSection.classList.add("expanded");
    const resultContent = document.getElementById("result-content");
    resultContent.classList.remove("visible");

    setTimeout(() => {
      document.getElementById("producto-info").innerHTML = `
        <div class="result-item">
          <strong>Producto:</strong>
          <span>${ultimaCotizacion.producto}</span>
        </div>
      `;
      document.getElementById("peso-result").textContent = `${ultimaCotizacion.peso.toFixed(2)} kg (se redondea a ${Math.ceil(ultimaCotizacion.peso)} kg)`;
      document.getElementById("valor-result").textContent = `$${ultimaCotizacion.valor.toFixed(2)}`;
      document.getElementById("desaduanaje").textContent = `$${ultimaCotizacion.desaduanaje.toFixed(2)}`;
      document.getElementById("impuestos").textContent = `$${ultimaCotizacion.impuestos.toFixed(2)}`;
      document.getElementById("envio-total").textContent = `$${ultimaCotizacion.envioTotal.toFixed(2)}`;
      document.getElementById("total").textContent = `$${ultimaCotizacion.total.toFixed(2)}`;
      resultContent.classList.add("visible");
    }, 50);
  }

  function actualizarEnlaceWhatsApp() {
    if (!ultimaCotizacion) return;
    let mensaje = "Hola SEA Express, quiero aprovechar el descuento de primera compra para este env√≠o:\n\n";
    mensaje += `üì¶ Producto: ${ultimaCotizacion.producto || "Sin descripci√≥n"}\n`;
    mensaje += `‚öñÔ∏è Peso: ${ultimaCotizacion.peso.toFixed(2)} kg (redondeado a ${Math.ceil(ultimaCotizacion.peso)} kg)\n`;
    mensaje += `üí∞ Valor declarado: $${ultimaCotizacion.valor.toFixed(2)}\n`;
    mensaje += `üì¶ Desaduanaje: $${ultimaCotizacion.desaduanaje.toFixed(2)}\n`;
    mensaje += `üöö Precio de env√≠o: $${ultimaCotizacion.envioTotal.toFixed(2)}\n`;
    if (ultimaCotizacion.impuestos > 0) {
      mensaje += `üèõÔ∏è Impuestos: $${ultimaCotizacion.impuestos.toFixed(2)}\n`;
    }
    mensaje += `üîí Seguro: $${ultimaCotizacion.seguro.toFixed(2)}\n`;
    mensaje += `üíµ Total con todo: $${ultimaCotizacion.total.toFixed(2)}\n\n`;
    mensaje += "Por favor, env√≠enme informaci√≥n sobre el descuento para primera compra.";

    const encodedMessage = encodeURIComponent(mensaje);
    document.getElementById("whatsapp-link").href = `https://wa.me/51923465624?text=${encodedMessage}`;
  }
</script>
